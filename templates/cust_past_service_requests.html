<!-- Search Input -->
<div class="mb-3">
    <input type="text" id="searchInput" class="form-control" placeholder="Search Service Requests..." onkeyup="searchTable()">
</div>

<div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
    <table class="table table-bordered table-striped" id="serviceRequestsTable">
        <thead>
            <tr>
                <th>S.No</th>
                <th>Service Name</th>
                <th>Professional Name</th>
                <th>Professional Phone</th>
                <th>Status</th>
                <th>Requested Date</th>
                <th>Action</th> <!-- Action column for the button -->
            </tr>
        </thead>
        <tbody>
            {% for request in service_requests %}
            <tr>
                <td>{{ loop.index }}</td> <!-- Serial number -->
                <td>{{ request.service_name }}</td>
                <td>{{ request.professional_name if request.professional_name else 'N/A' }}</td>
                <td>{{ request.professional_phone if request.professional_phone else 'N/A' }}</td>
                <td>{{ request.status }}</td>
                <td>
                    {{ request.date_of_request.strftime('%Y-%m-%d') if request.date_of_request else 'N/A' }}</td> <!-- Requested Date -->
                <td>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#actionModal" 
                            data-request-id="{{ request.id }}" 
                            data-service-name="{{ request.service_name }}" 
                            data-professional-name="{{ request.professional_name }}" 
                            data-professional-phone="{{ request.professional_phone }}" 
                            data-requested-date="{{ request.requested_date }}" 
                            data-service-description="{{ request.description }}" 
                            data-professional-profile-url="{{ request.professional_profile_url }}">
                        View Details
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal Structure -->
<div class="modal fade" id="actionModal" tabindex="-1" aria-labelledby="actionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form method="post" action="/handle_service_action">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="actionModalLabel">Service Request Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Service Request Information -->
                    <p><strong>Request ID:</strong> <span id="modal-request-id"></span></p>
                    <p><strong>Service Name:</strong> <span id="modal-service-name"></span></p>
                    <p><strong>Description:</strong> <span id="modal-service-description"></span></p>
                    <p><strong>Status:</strong> <span id="modal-request-status"></span></p>
                    <p><strong>Requested Date:</strong> <span id="modal-requested-date"></span></p>
                    <p><strong>Professional Name:</strong> <span id="modal-professional-name"></span></p>
                    <p><strong>Professional Phone:</strong> <span id="modal-professional-phone"></span></p>

                    <!-- View Professional Profile Link -->
                    <div class="mb-3" id="professional-profile-link-container">
                        <a href="#" id="modal-professional-profile" class="btn btn-info" target="_blank" style="display: none;">View Professional Profile</a>
                    </div>

                    <!-- Hidden input for request ID -->
                    <input type="hidden" name="request_id" id="modal-request-id-field">

                    <!-- Change Service Date Input -->
                    <div class="mb-3">
                        <label for="service-date" class="form-label">Change Service Date:</label>
                        <input type="date" name="service_date" id="service-date" class="form-control">
                    </div>

                    <!-- Rating Section (Star Rating) -->
                    <div class="mb-3">
                        <label for="rating" class="form-label">Rate the Service:</label>
                        <div id="rating" class="rating">
                            <input type="radio" name="rating" value="1" id="star1" /><label for="star1">★</label>
                            <input type="radio" name="rating" value="2" id="star2" /><label for="star2">★</label>
                            <input type="radio" name="rating" value="3" id="star3" /><label for="star3">★</label>
                            <input type="radio" name="rating" value="4" id="star4" /><label for="star4">★</label>
                            <input type="radio" name="rating" value="5" id="star5" /><label for="star5">★</label>
                        </div>
                    </div>

                    <!-- Service Description Input -->
                    <div class="mb-3">
                        <label for="service-description" class="form-label">Service Description:</label>
                        <textarea name="service_description" id="service-description" class="form-control" rows="3"></textarea>
                    </div>

                    <!-- Remarks/Notes for Completion -->
                    <div class="mb-3">
                        <label for="completion-notes" class="form-label">Completion Notes:</label>
                        <textarea name="completion_notes" id="completion-notes" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Confirm Action</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    const actionModal = document.getElementById('actionModal');
    actionModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget; // Button that triggered the modal
        const requestId = button.getAttribute('data-request-id');
        const serviceName = button.getAttribute('data-service-name');
        const requestedDate = button.getAttribute('data-requested-date');
        const professionalName = button.getAttribute('data-professional-name');
        const professionalPhone = button.getAttribute('data-professional-phone');
        const serviceDescription = button.getAttribute('data-service-description');
        const professionalProfileUrl = button.getAttribute('data-professional-profile-url');

        // Update modal content
        document.getElementById('modal-request-id').textContent = requestId;
        document.getElementById('modal-service-name').textContent = serviceName;
        document.getElementById('modal-service-description').textContent = serviceDescription;
        document.getElementById('modal-requested-date').textContent = requestedDate;
        document.getElementById('modal-professional-name').textContent = professionalName || 'N/A';
        document.getElementById('modal-professional-phone').textContent = professionalPhone || 'N/A';
        document.getElementById('modal-request-id-field').value = requestId;

        // Show the professional profile link if URL is available
        const profileLink = document.getElementById('modal-professional-profile');
        const profileLinkContainer = document.getElementById('professional-profile-link-container');
        if (professionalProfileUrl) {
            profileLink.setAttribute('href', professionalProfileUrl);
            profileLink.style.display = 'inline-block'; // Show link
        } else {
            profileLink.style.display = 'none'; // Hide link if no URL
        }
    });

    // Search Function for Filtering
    function searchTable() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const table = document.getElementById('serviceRequestsTable');
        const rows = table.getElementsByTagName('tr');

        for (let i = 1; i < rows.length; i++) {
            const cells = rows[i].getElementsByTagName('td');
            let rowContainsSearchTerm = false;

            for (let j = 0; j < cells.length; j++) {
                const cell = cells[j];
                if (cell.textContent.toLowerCase().includes(searchTerm)) {
                    rowContainsSearchTerm = true;
                    break;
                }
            }

            if (rowContainsSearchTerm) {
                rows[i].style.display = '';
            } else {
                rows[i].style.display = 'none';
            }
        }
    }
</script>

<style>
    .rating input {
        display: none;
    }

    .rating label {
        color: #ddd;
        font-size: 25px;
        cursor: pointer;
    }

    .rating input:checked ~ label {
        color: gold;
    }

    .rating label:hover,
    .rating label:hover ~ label {
        color: gold;
    }
</style>
